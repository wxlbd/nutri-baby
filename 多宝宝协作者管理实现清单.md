# å¤šå®å®ç®¡ç†ä¸‹åä½œè€…ç®¡ç† - å®ç°æ¸…å•

## ğŸ“‹ å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. è®¾è®¡æ–‡æ¡£
- âœ… **åä½œè€…ç®¡ç†è®¾è®¡æ–¹æ¡ˆ.md** - å®Œæ•´çš„è®¾è®¡æ–‡æ¡£ï¼ŒåŒ…å«æ¶æ„ã€æµç¨‹ã€UIè®¾è®¡

### 2. ç±»å‹å®šä¹‰
- âœ… **src/types/collaborator.ts** - æ‰€æœ‰åä½œè€…ç›¸å…³çš„ TypeScript ç±»å‹å®šä¹‰
  - `BabyCollaborator` - åä½œè€…ä¿¡æ¯
  - `MyPermission` - ç”¨æˆ·æƒé™ä¿¡æ¯
  - `RolePermissions` - è§’è‰²æƒé™å®šä¹‰
  - `InviteCollaboratorRequest/Response` - é‚€è¯·è¯·æ±‚å’Œå“åº”
  - æƒé™å¸¸é‡å’Œå·¥å…·å‡½æ•°

### 3. å·¥å…·å‡½æ•°
- âœ… **src/utils/permission.ts** - æƒé™æ£€æŸ¥å·¥å…·åº“
  - `canViewBaby()` - æ£€æŸ¥æ˜¯å¦èƒ½æŸ¥çœ‹å®å®
  - `canEditRecords()` - æ£€æŸ¥æ˜¯å¦èƒ½ç¼–è¾‘è®°å½•
  - `canManageBaby()` - æ£€æŸ¥æ˜¯å¦èƒ½ç®¡ç†å®å®
  - `canManageCollaborators()` - æ£€æŸ¥æ˜¯å¦èƒ½ç®¡ç†åä½œè€…
  - `canInviteCollaborators()` - æ£€æŸ¥æ˜¯å¦èƒ½é‚€è¯·
  - `hasPermission()` - æ£€æŸ¥ç‰¹å®šæƒé™
  - `isPermissionExpired()` - æ£€æŸ¥æƒé™æ˜¯å¦è¿‡æœŸ
  - `getExpirationWarning()` - è·å–è¿‡æœŸè­¦å‘Š
  - å„ç§æ ‡ç­¾å’Œæè¿°å‡½æ•°

### 4. API æ¥å£
- âœ… **src/api/collaborator.ts** - åä½œè€…ç›¸å…³ API æ¥å£
  - `apiFetchCollaborators()` - è·å–åä½œè€…åˆ—è¡¨
  - `apiInviteCollaborator()` - é‚€è¯·åä½œè€…
  - `apiRemoveCollaborator()` - ç§»é™¤åä½œè€…
  - `apiUpdateCollaboratorRole()` - æ›´æ–°è§’è‰²æƒé™
  - `apiGetInvitationByCode()` - è·å–é‚€è¯·è¯¦æƒ…
  - `apiJoinBaby()` - ç¡®è®¤åŠ å…¥
  - `apiBatchInviteCollaborators()` - æ‰¹é‡é‚€è¯·ï¼ˆå¯é€‰ï¼‰

### 5. UI ç»„ä»¶
- âœ… **src/components/BabyCollaboratorsPreview.vue** - å®å®åˆ—è¡¨å¡ç‰‡ä¸­çš„åä½œè€…é¢„è§ˆç»„ä»¶
  - æ˜¾ç¤ºåä½œè€…æ€»æ•°
  - åˆ—è¡¨æ˜¾ç¤ºå‰3ä¸ªåä½œè€…
  - æ”¯æŒç‚¹å‡»è¿›å…¥è¯¦ç»†ç®¡ç†é¡µé¢
  - å“åº”å¼è®¾è®¡ï¼Œé€‚é…å„ç§å±å¹•

### 6. é¡µé¢å®ç°
- âœ… **src/pages/baby/collaborators/collaborators.vue** - åä½œè€…ç®¡ç†è¯¦ç»†é¡µé¢
  - æ˜¾ç¤ºæ‰€æœ‰åä½œè€…åˆ—è¡¨
  - æœç´¢åä½œè€…åŠŸèƒ½
  - å˜æ›´æƒé™å¯¹è¯æ¡†
  - ç§»é™¤ç¡®è®¤å¯¹è¯æ¡†
  - é‚€è¯·æ–°åä½œè€…å…¥å£
  - å®Œæ•´çš„æƒé™å±•ç¤º

## ğŸ”§ éœ€è¦å®Œæˆçš„é›†æˆå·¥ä½œ

### ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œæ–°é¡µé¢ (src/pages.json)

```json
{
  "path": "pages/baby/collaborators/collaborators",
  "style": {
    "navigationBarTitleText": "ç®¡ç†åä½œè€…"
  }
}
```

### ç¬¬äºŒæ­¥ï¼šæ›´æ–°å®å®åˆ—è¡¨é¡µé¢

åœ¨ `src/pages/baby/list/list.vue` ä¸­ï¼š

1. å¯¼å…¥æ–°ç»„ä»¶å’Œå·¥å…·å‡½æ•°
```typescript
import BabyCollaboratorsPreview from '@/components/BabyCollaboratorsPreview.vue';
import { apiFetchCollaborators } from '@/api/collaborator';
```

2. åŠ è½½åä½œè€…æ•°æ®
```typescript
const babyCollaborators = ref<Map<string, BabyCollaborator[]>>(new Map());

const loadCollaborators = async (babyId: string) => {
  try {
    const data = await apiFetchCollaborators(babyId);
    babyCollaborators.value.set(babyId, data);
  } catch (error) {
    console.error('åŠ è½½åä½œè€…å¤±è´¥:', error);
  }
};

const loadBabyList = async () => {
  const data = await apiFetchBabyList();
  babyList.value = data;
  // å¹¶è¡ŒåŠ è½½æ‰€æœ‰å®å®çš„åä½œè€…
  await Promise.all(
    data.map(baby => loadCollaborators(baby.babyId))
  );
};
```

3. åœ¨å®å®å¡ç‰‡ä¸­æ·»åŠ ç»„ä»¶
```vue
<BabyCollaboratorsPreview
  :baby-id="baby.babyId"
  :collaborators="babyCollaborators.get(baby.babyId)"
  @go-to-collaborators="goToCollaborators"
/>
```

4. å®ç°å¯¼èˆªæ–¹æ³•
```typescript
const goToCollaborators = (babyId: string) => {
  const baby = babyList.value.find(b => b.babyId === babyId);
  uni.navigateTo({
    url: `/pages/baby/collaborators/collaborators?babyId=${babyId}&babyName=${baby?.name}`,
  });
};
```

### ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°é¡µé¢è®¿é—®æƒé™æ£€æŸ¥

åœ¨å„ä¸ªè®°å½•é¡µé¢ (feeding.vue, sleep.vue ç­‰) ä¸­æ·»åŠ æƒé™æ£€æŸ¥ï¼š

```typescript
import { canEditRecords } from '@/utils/permission';
import type { MyPermission } from '@/types/collaborator';

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æƒé™
onMounted(() => {
  const permission = getCurrentBabyPermission(); // ä»storeè·å–

  if (!canEditRecords(permission)) {
    uni.showToast({
      title: 'æ‚¨æ— æƒæ·»åŠ è®°å½•',
      icon: 'none',
    });
    uni.navigateBack();
  }
});
```

### ç¬¬å››æ­¥ï¼šæ‰©å±• Baby Store

æ›´æ–° `src/store/baby.ts` æ·»åŠ æƒé™ä¿¡æ¯ï¼š

```typescript
interface BabyStore {
  // ç°æœ‰çŠ¶æ€...
  currentBabyId: Ref<string>;
  babyList: Ref<BabyProfile[]>;

  // æ–°å¢çŠ¶æ€
  collaboratorsMap: Ref<Map<string, BabyCollaborator[]>>;
  myPermissionsMap: Ref<Map<string, MyPermission>>;
}

export const baby = reactive<BabyStore>({
  currentBabyId: '',
  babyList: [],
  collaboratorsMap: new Map(),
  myPermissionsMap: new Map(),
});

// æ–°å¢æ–¹æ³•
export function setCollaborators(
  babyId: string,
  collaborators: BabyCollaborator[]
) {
  baby.collaboratorsMap.set(babyId, collaborators);
}

export function setMyPermission(
  babyId: string,
  permission: MyPermission
) {
  baby.myPermissionsMap.set(babyId, permission);
}

export function getMyPermission(babyId: string): MyPermission | undefined {
  return baby.myPermissionsMap.get(babyId);
}
```

### ç¬¬äº”æ­¥ï¼šå¤„ç†æƒé™è¿‡æœŸæƒ…å†µ

åœ¨é¦–é¡µ (src/pages/index/index.vue) ä¸­æ£€æŸ¥æƒé™è¿‡æœŸï¼š

```typescript
import { isPermissionExpired, getExpirationWarning } from '@/utils/permission';

const checkPermissions = () => {
  for (const [babyId, permission] of babyStore.myPermissionsMap) {
    if (isPermissionExpired(permission)) {
      // ç§»é™¤è¿‡æœŸçš„å®å®
      babyStore.babyList = babyStore.babyList.filter(
        b => b.babyId !== babyId
      );

      if (babyStore.currentBabyId === babyId) {
        // å¦‚æœå½“å‰é€‰ä¸­çš„å®å®æƒé™è¿‡æœŸ
        babyStore.currentBabyId = '';
      }
    } else {
      const warning = getExpirationWarning(permission);
      if (warning) {
        console.warn(`[æƒé™è­¦å‘Š] ${babyId}: ${warning}`);
      }
    }
  }
};

onShow(() => {
  checkPermissions();
});
```

## ğŸ¯ æƒé™æ£€æŸ¥é›†æˆç‚¹

### è®°å½•é¡µé¢ (feeding, sleep, diaper, growth)

```typescript
// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æƒé™
const permission = getMyPermission(currentBabyId.value);

// ä¸å…è®¸æŸ¥çœ‹
if (!canViewBaby(permission)) {
  showToast('æ‚¨æ— æƒæŸ¥çœ‹æ­¤å®å®');
  return;
}

// ä¸å…è®¸æ·»åŠ /ç¼–è¾‘
if (!canEditRecords(permission)) {
  showToast('æ‚¨æ— æƒä¿®æ”¹æ­¤å®å®çš„è®°å½•');
  return;
}
```

### å®å®ç®¡ç† (edit, delete)

```typescript
const permission = getMyPermission(babyId);

// æ£€æŸ¥ç¼–è¾‘æƒé™
if (!canManageBaby(permission)) {
  showToast('æ‚¨æ— æƒç®¡ç†æ­¤å®å®');
  return;
}
```

### é‚€è¯·åä½œ (invite)

```typescript
const permission = getMyPermission(babyId);

if (!canManageCollaborators(permission)) {
  showToast('æ‚¨æ— æƒé‚€è¯·åä½œè€…');
  return;
}
```

## ğŸ“± åç«¯ API ç¡®è®¤æ¸…å•

éœ€è¦ç¡®è®¤åç«¯æ˜¯å¦æä¾›ä»¥ä¸‹ç«¯ç‚¹ï¼ˆä»æ¢ç´¢ç»“æœæ¨æ–­ï¼‰ï¼š

- [ ] `GET /babies` - è·å–å®å®åˆ—è¡¨ï¼ˆè¿”å›ç”¨æˆ·å¯è®¿é—®çš„ï¼‰
- [ ] `GET /babies/{babyId}/collaborators` - è·å–åä½œè€…åˆ—è¡¨
- [ ] `POST /babies/{babyId}/collaborators/invite` - ç”Ÿæˆé‚€è¯·
- [ ] `DELETE /babies/{babyId}/collaborators/{openid}` - ç§»é™¤åä½œè€…
- [ ] `PUT /babies/{babyId}/collaborators/{openid}/role` - æ›´æ–°è§’è‰²
- [ ] `GET /invitations/code/{shortCode}` - è·å–é‚€è¯·è¯¦æƒ…
- [ ] `POST /babies/join` - ç¡®è®¤åŠ å…¥

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šæŸ¥çœ‹åä½œè€…åˆ—è¡¨
1. æ‰“å¼€å®å®åˆ—è¡¨
2. ç‚¹å‡»æŸä¸ªå®å®çš„åä½œè€…åŒºåŸŸ
3. éªŒè¯æ˜¾ç¤ºæ‰€æœ‰åä½œè€…åŠå…¶æƒé™

### åœºæ™¯2ï¼šé‚€è¯·åä½œè€…
1. è¿›å…¥åä½œè€…ç®¡ç†é¡µé¢
2. ç‚¹å‡»"é‚€è¯·æ–°åä½œè€…"
3. é€‰æ‹©è§’è‰²å’Œæœ‰æ•ˆæœŸ
4. ç”ŸæˆäºŒç»´ç å¹¶åˆ†äº«
5. éªŒè¯é‚€è¯·ä¿¡æ¯æ­£ç¡®

### åœºæ™¯3ï¼šå˜æ›´æƒé™
1. è¿›å…¥åä½œè€…ç®¡ç†é¡µé¢
2. ç‚¹å‡»æŸä¸ªåä½œè€…çš„"å˜æ›´æƒé™"
3. æ›´æ”¹è§’è‰²ä¸º editor
4. éªŒè¯æƒé™å·²æ›´æ–°

### åœºæ™¯4ï¼šæƒé™è¿‡æœŸå¤„ç†
1. è®¾ç½®æŸä¸ªåä½œè€…æƒé™æœ‰æ•ˆæœŸä¸ºä»Šå¤©
2. å…³é—­å¹¶é‡æ–°æ‰“å¼€åº”ç”¨
3. éªŒè¯è¿‡æœŸåä½œè€…è¢«éšè—

### åœºæ™¯5ï¼šæƒé™æ£€æŸ¥
1. ä»¥ viewer èº«ä»½è®¿é—®å®å®
2. å°è¯•æ·»åŠ è®°å½•
3. éªŒè¯è¢«æ‹’ç»å¹¶æ˜¾ç¤ºæç¤º

## ğŸ“Š æ–‡ä»¶ç»Ÿè®¡

| åˆ†ç±» | æ•°é‡ | ç”¨é€” |
|------|------|------|
| ç±»å‹å®šä¹‰ | 1 | TypeScript ç±»å‹ |
| å·¥å…·å‡½æ•° | 1 | æƒé™æ£€æŸ¥å’Œè¾…åŠ©å‡½æ•° |
| API æ¥å£ | 1 | åç«¯ API è°ƒç”¨ |
| ç»„ä»¶ | 1 | UI ç»„ä»¶ |
| é¡µé¢ | 1 | åä½œè€…ç®¡ç†é¡µé¢ |
| æ–‡æ¡£ | 1 | å®Œæ•´è®¾è®¡æ–¹æ¡ˆ |
| **åˆè®¡** | **6** | |

## ğŸš€ å®ç°ä¼˜å…ˆçº§

### ä¼˜å…ˆçº§ 1 (å¿…éœ€)
- [ ] æ³¨å†Œåä½œè€…ç®¡ç†é¡µé¢
- [ ] æ›´æ–°å®å®åˆ—è¡¨é¡µé¢é›†æˆç»„ä»¶
- [ ] åœ¨è®°å½•é¡µé¢æ·»åŠ æƒé™æ£€æŸ¥
- [ ] æµ‹è¯•æƒé™æ£€æŸ¥æµç¨‹

### ä¼˜å…ˆçº§ 2 (é‡è¦)
- [ ] åœ¨é‚€è¯·é¡µé¢éªŒè¯æƒé™
- [ ] æ·»åŠ æƒé™è¿‡æœŸæç¤º
- [ ] å®ç°æƒé™è¿‡æœŸæ—¶çš„å®å®éšè—

### ä¼˜å…ˆçº§ 3 (ä¼˜åŒ–)
- [ ] æ·»åŠ æƒé™å˜æ›´çš„å®æ—¶é€šçŸ¥
- [ ] æ”¯æŒæ‰¹é‡é‚€è¯·
- [ ] æ·»åŠ åä½œå†å²æ—¥å¿—

## ğŸ’¡ å…³é”®è®¾è®¡å†³ç­–

1. **æƒé™å­˜å‚¨æ–¹å¼**: ä½¿ç”¨ Map<babyId, MyPermission> å­˜å‚¨å½“å‰ç”¨æˆ·å¯¹æ¯ä¸ªå®å®çš„æƒé™
2. **æƒé™æ£€æŸ¥ä½ç½®**: åœ¨é¡µé¢åˆå§‹åŒ–å’Œæ•æ„Ÿæ“ä½œå‰æ£€æŸ¥
3. **è¿‡æœŸå¤„ç†æ–¹å¼**: è¿‡æœŸåç›´æ¥éšè—å®å®ï¼Œä¸æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
4. **UI å±•ç¤ºæ–¹å¼**: å®å®å¡ç‰‡ä¸­æ˜¾ç¤ºåä½œè€…é¢„è§ˆï¼Œè¯¦æƒ…åœ¨å•ç‹¬é¡µé¢

## ğŸ“ åç»­ç»´æŠ¤å»ºè®®

1. å®šæœŸæ£€æŸ¥æƒé™æ£€æŸ¥å‡½æ•°çš„ä½¿ç”¨æƒ…å†µ
2. ç›‘æ§æƒé™æ‹’ç»çš„æ—¥å¿—ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
3. æ ¹æ®ç”¨æˆ·åé¦ˆä¼˜åŒ–æƒé™å˜æ›´æµç¨‹
4. è€ƒè™‘æ·»åŠ æƒé™å˜æ›´çš„å®¡è®¡æ—¥å¿—
