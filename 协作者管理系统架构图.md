# 协作者管理系统 - 架构视图

## 1. 数据关系模型

### ER 图
```
┌─────────────────────────┐
│       User (用户)        │
│ ┌─────────────────────┐ │
│ │ • openid (PK)      │ │
│ │ • nickName         │ │
│ │ • avatarUrl        │ │
│ │ • defaultBabyId    │ │
│ └─────────────────────┘ │
└────────────┬────────────┘
             │
      ┌──────┴──────┐
      │ 可协作多个  │
      │   宝宝      │
      │             │
      ↓             ↓
┌──────────────┐  ┌──────────────┐
│ Baby (宝宝)  │  │ Baby (宝宝)  │
│ ┌──────────┐│  │ ┌──────────┐│
│ │• babyId  ││  │ │• babyId  ││
│ │• name    ││  │ │• name    ││
│ │•creator  ││  │ │•creator  ││
│ │  Id(FK)  ││  │ │  Id(FK)  ││
│ └──────────┘│  │ └──────────┘│
└──────┬──────┘  └──────┬──────┘
       │                │
       └────┬───────────┘
            │ 一对多
            ↓
   ┌──────────────────────┐
   │  BabyCollaborator    │
   │ ┌────────────────────┤
   │ │ • babyId (FK)      │
   │ │ • openid (FK)      │
   │ │ • role             │
   │ │ • accessType       │
   │ │ • expiresAt        │
   │ │ • joinedAt         │
   │ └────────────────────┤
   │ [PK: babyId + openid]│
   └──────────────────────┘
            ↑
            │ 多对多
            │
      ┌─────┴──────┐
      │ 通过邀请   │
      │ 创建关系   │
      │            │
      ↓            ↓
┌──────────────────────┐
│  BabyInvitation      │
│ ┌──────────────────┐ │
│ │ • babyId (FK)    │ │
│ │ • token (PK)     │ │
│ │ • shortCode      │ │
│ │ • targetOpenid   │ │
│ │ • expiresAt      │ │
│ │ • creatorOpenid  │ │
│ └──────────────────┘ │
└──────────────────────┘
```

## 2. 权限检查流程图

```
┌──────────────────────────────────────┐
│  用户访问宝宝数据或执行操作           │
└────────────┬─────────────────────────┘
             │
             ↓
     ┌──────────────────┐
     │ 获取用户权限     │
     │ getMyPermission()│
     └────────┬─────────┘
              │
              ↓
    ┌─────────────────────┐
    │ 权限是否存在？       │
    └──┬──────────┬──────┘
       │          │
      否         是
       │          │
       ↓          ↓
    ❌拒绝   ┌─────────────────┐
           │ 权限是否过期？    │
           │ isExpired()      │
           └──┬──────────┬────┘
              │          │
             是          否
              │          │
              ↓          ↓
           ❌拒绝   ┌────────────────┐
                   │ 检查操作权限   │
                   │ hasPermission()│
                   └──┬───────┬────┘
                      │       │
                     否      是
                      │       │
                      ↓       ↓
                   ❌拒绝   ✅允许执行
```

## 3. 邀请流程时序图

```
用户A (创建者)          系统              用户B (被邀请者)
     │                │                    │
     │─[邀请协作者]─→ │                    │
     │                │                    │
     │← POST /invite ←│                    │
     │                │                    │
     │             ┌─────────────────┐    │
     │             │ 生成邀请记录     │    │
     │             │ Token + ShortCode│    │
     │             └─────────────────┘    │
     │                │                    │
     │←[二维码+Token]─│                    │
     │                │                    │
     │─ 分享二维码 ─→ │                    │
     │                │                    │
     │                │← 扫描二维码 ←│
     │                │                    │
     │                │─[查询邀请]─→      │
     │                │                    │
     │                │← GET /invitations/code/AB12CD
     │                │                    │
     │                ├─[显示邀请详情]─→  │
     │                │                    │
     │                │←[点击确认加入]─    │
     │                │                    │
     │                │← POST /babies/join
     │                │                    │
     │             ┌─────────────────┐    │
     │             │ 创建协作关系     │    │
     │             │ BabyCollaborator│    │
     │             └─────────────────┘    │
     │                │                    │
     │                ├─[加入成功]────→   │
     │                │                    │
     │←─[同步列表]─── │                    │
     │                │                    │
```

## 4. 宝宝卡片展示层次

```
┌─────────────────────────────────────────────────────┐
│            宝宝列表页面 (list.vue)                   │
├─────────────────────────────────────────────────────┤
│                                                      │
│  ┌───────────────────────────────────────────────┐  │
│  │        宝宝卡片 (baby-card)                   │  │
│  │                                               │  │
│  │  ┌─────────────────────────────────────────┐ │  │
│  │  │ [头像] 小明              [默认标签]      │ │  │
│  │  │       3个月               ✨            │ │  │
│  │  └─────────────────────────────────────────┘ │  │
│  │  ├──────────────────────────────────────────┤  │
│  │  │  协作者预览 (BabyCollaboratorsPreview)   │  │
│  │  │  ┌────────────────────────────────────┐ │  │
│  │  │  │ 👥 协作者 (3人)              →      │ │  │
│  │  │  │ ├─ [👤] 妈妈 (admin)              │ │  │
│  │  │  │ ├─ [👤] 爸爸 (editor)            │ │  │
│  │  │  │ └─ [👤] 奶奶 (viewer)            │ │  │
│  │  │  └────────────────────────────────────┘ │  │
│  │  ├──────────────────────────────────────────┤  │
│  │  │ [邀请] [设为默认] [编辑] [删除]         │  │
│  │  └──────────────────────────────────────────┘  │
│  │                                               │  │
│  │  点击协作者预览区域 ↓                         │  │
│  │  ┌─────────────────────────────────────────┐ │  │
│  │  │  进入协作者管理页面                    │ │  │
│  │  │  (pages/baby/collaborators)            │ │  │
│  │  └─────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────┘  │
│                                                      │
└─────────────────────────────────────────────────────┘
```

## 5. 权限检查决策树

```
当前操作: 用户尝试添加喂养记录

              用户是否有权限？
                    │
        ┌───────────┼───────────┐
        │           │           │
       否           ✓           │
        │           │    权限过期？
        ↓           │           │
    ❌ 拒绝         ├─是→❌拒绝
                    │
                   否
                    │
                    ↓
          用户的角色是什么？
                    │
        ┌───────────┼───────────┐
        │           │           │
     admin       editor       viewer
        │           │           │
        ↓           ↓           ↓
     可编辑  可编辑  ❌ 拒绝
        │           │
        └─→ ✅允许执行
```

## 6. 前端代码分层架构

```
┌─────────────────────────────────────────────────┐
│              UI 层 (展示层)                     │
│ ┌──────────────────────────────────────────┐   │
│ │  Pages (页面):                           │   │
│ │  • list.vue (宝宝列表)                  │   │
│ │  • collaborators.vue (协作者管理)      │   │
│ │  • feeding.vue (记录页面)               │   │
│ └──────────────────────────────────────────┘   │
│ ┌──────────────────────────────────────────┐   │
│ │  Components (组件):                      │   │
│ │  • BabyCollaboratorsPreview (预览组件) │   │
│ │  • RoleChangeDialog (权限变更弹窗)     │   │
│ └──────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────┐
│             业务逻辑层 (应用层)                  │
│ ┌──────────────────────────────────────────┐   │
│ │  Utils (工具):                           │   │
│ │  • permission.ts (权限检查)             │   │
│ │  • date.ts (日期处理)                   │   │
│ │  • request.ts (HTTP 请求)               │   │
│ └──────────────────────────────────────────┘   │
│ ┌──────────────────────────────────────────┐   │
│ │  Store (状态管理):                       │   │
│ │  • baby.ts (宝宝状态)                   │   │
│ │  • user.ts (用户状态)                   │   │
│ └──────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────┐
│             数据访问层 (API 层)                 │
│ ┌──────────────────────────────────────────┐   │
│ │  API (接口调用):                         │   │
│ │  • collaborator.ts (协作者 API)        │   │
│ │  • baby.ts (宝宝 API)                  │   │
│ │  • feeding.ts (记录 API)                │   │
│ └──────────────────────────────────────────┘   │
└──────────────────────┬──────────────────────────┘
                       │
┌──────────────────────┴──────────────────────────┐
│             后端服务层 (远程)                   │
│ ┌──────────────────────────────────────────┐   │
│ │  HTTP API:                               │   │
│ │  • GET /babies/{id}/collaborators       │   │
│ │  • POST /babies/{id}/collaborators/invite
│ │  • DELETE /babies/{id}/collaborators/...│   │
│ │  • PUT /babies/{id}/collaborators/.../role
│ └──────────────────────────────────────────┘   │
└──────────────────────────────────────────────────┘
```

## 7. 权限状态转换图

```
                   ┌─ 永久权限
                   │  (不过期)
                   │
  权限创建 ─→ 权限生效
                   │
                   └─ 临时权限
                      │
                      ├─ 有效期内
                      │  ├─ ≥ 7天到期 → 正常
                      │  ├─ 7天内到期 → 警告
                      │  └─ < 24h到期 → 紧急
                      │
                      └─ 已过期 → 自动禁用
                               → 隐藏宝宝
                               → 移除权限
```

## 8. 协作者类型分布示例

```
小明的宝宝档案中:

   Admin (1人)
   ├─ 王女士 (创建者，永久权限)
   │  └─ 100% 权限控制

   Editor (2人)
   ├─ 王先生 (丈夫，永久权限)
   │  └─ 可编辑记录，可邀请
   └─ 李阿姨 (保姆，临时权限)
      └─ 有效期至 2025-01-30
         权限将在 15 天后过期 ⚠️

   Viewer (3人)
   ├─ 奶奶 (永久权限)
   │  └─ 仅查看，无法修改
   ├─ 爷爷 (临时权限，已过期)
   │  └─ ❌ 自动移除
   └─ 社区医生 (临时权限)
      └─ 有效期至 2025-02-28

统计:
  • 总协作者: 6人
  • 有效协作者: 5人
  • 即将过期: 1人 (保姆)
  • 已过期: 1人 (爷爷，已移除)
```

## 9. API 调用顺序图

```
[页面加载 - cooperators.vue]
          │
          ├→ GET /babies/{babyId}/collaborators
          │  └→ 获取所有协作者列表
          │
          └→ 显示协作者信息

[用户操作 - 变更权限]
          │
          ├→ 打开权限变更对话框
          │  └→ 显示当前权限信息
          │
          ├→ 用户选择新权限
          │
          ├→ PUT /babies/{babyId}/collaborators/{openid}/role
          │  └→ 服务器更新权限
          │
          ├→ 本地列表同步
          │
          └→ 显示更新成功提示

[用户操作 - 移除协作者]
          │
          ├→ DELETE /babies/{babyId}/collaborators/{openid}
          │  └→ 服务器删除协作关系
          │
          ├→ 本地列表移除协作者
          │
          └→ 显示移除成功提示
```

## 10. 权限有效期生命周期

```
创建邀请时间: 2024-11-11

              永久权限              临时权限(有效期30天)
                 │                        │
                 │                   2024-11-11
                 │                        │
                 │                   正常使用
                 │                        │
              ✅ 永久有效            有效期内 (≥7天)
                 │                   ✅ 正常使用
                 │                        │
                 │                   2024-12-04 (有效期-7天)
                 │                   ⚠️  即将过期警告
                 │                        │
                 │                   2024-12-10 (有效期-1天)
                 │                   🚨 紧急续期提醒
                 │                        │
                 │                   2024-12-11 (到期日期)
                 │                   ❌ 权限过期
                 │                        │
                 │                   自动禁用权限
                 │                   隐藏该宝宝
                 │                   移除协作关系
                 │
              无限期使用


权限状态简表:
┌────────────────┬────────────┬──────────┬─────────┐
│ 权限类型       │ 创建至-7天 │ -7天至0天│ 过期后  │
├────────────────┼────────────┼──────────┼─────────┤
│ 永久权限       │ ✅ 正常    │ ✅ 正常  │ ✅ 正常 │
│ 临时权限(30d)  │ ✅ 正常    │ ⚠️ 警告  │ ❌ 禁用 │
└────────────────┴────────────┴──────────┴─────────┘
```

---

**说明**: 本文档展示了协作者管理系统的完整架构，从数据关系、流程、权限检查到具体的代码分层设计。
