# 协作者管理 - 快速参考卡片

## 🎯 30秒快速理解

**多宝宝场景下的协作关系：**
- 一个宝宝 → 多个协作者
- 每个协作者有独立权限（admin/editor/viewer）
- 权限可设置为永久或临时（带过期时间）

```
👩 妈妈(admin) ──┐
👨 爸爸(editor) ├─→ 小明的宝宝档案
👵 奶奶(viewer) ┘
```

---

## 🔧 权限速查表

| 权限 | Admin | Editor | Viewer |
|------|:-----:|:------:|:------:|
| 查看 | ✅ | ✅ | ✅ |
| 编辑 | ✅ | ✅ | ❌ |
| 邀请 | ✅ | ✅ | ❌ |
| 管理 | ✅ | ❌ | ❌ |

---

## 📂 文件清单

### 设计文档
```
协作者管理设计方案.md ............... 完整设计
多宝宝协作者管理实现清单.md ........ 实现步骤
协作者管理系统架构图.md ............ 架构说明
README_协作者管理.md ............... 本文档
```

### 代码文件
```
src/types/collaborator.ts ........... 类型定义
src/utils/permission.ts ............ 权限工具
src/api/collaborator.ts ............ API接口
src/components/BabyCollaboratorsPreview.vue .. 预览组件
src/pages/baby/collaborators/collaborators.vue .. 管理页面
```

---

## ⚡ 常用代码片段

### 权限检查
```typescript
// 导入
import { canEditRecords, isPermissionExpired } from '@/utils/permission';

// 使用
const permission = getMyPermission(babyId);

if (canEditRecords(permission)) {
  // 允许编辑
}

if (isPermissionExpired(permission)) {
  // 权限过期，隐藏宝宝
}
```

### 获取协作者
```typescript
import { apiFetchCollaborators } from '@/api/collaborator';

const collaborators = await apiFetchCollaborators(babyId);

collaborators.forEach(c => {
  console.log(c.nickName, c.role, c.expiresAt);
});
```

### 邀请协作者
```typescript
import { apiInviteCollaborator } from '@/api/collaborator';

const response = await apiInviteCollaborator(babyId, {
  targetOpenid: 'user_openid',
  role: 'editor',
  accessType: 'temporary',
  expiresAt: Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60,
});

// 分享 response.qrCodeUrl 二维码
```

---

## 📋 集成检查表

- [ ] 复制 5 个代码文件到项目
- [ ] 在 pages.json 注册新页面
- [ ] 在宝宝列表导入组件
- [ ] 在记录页面添加权限检查
- [ ] 测试权限拒绝功能
- [ ] 测试权限过期处理

---

## 🚦 权限检查函数速查

| 函数 | 说明 | 返回 |
|------|------|------|
| `canViewBaby()` | 能否查看 | boolean |
| `canEditRecords()` | 能否编辑记录 | boolean |
| `canManageBaby()` | 能否管理宝宝 | boolean |
| `canInviteCollaborators()` | 能否邀请 | boolean |
| `isPermissionExpired()` | 是否过期 | boolean |
| `hasPermission()` | 检查特定权限 | boolean |

---

## 🎨 UI 展示层次

```
宝宝列表
  └─ 宝宝卡片
      └─ 协作者预览组件
          └─ 点击进入
              └─ 协作者详情页
                  ├─ 列表显示
                  ├─ 变更权限
                  ├─ 移除协作者
                  └─ 邀请新协作者
```

---

## 📞 API 端点概览

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/babies/{id}/collaborators` | 获取协作者 |
| POST | `/babies/{id}/collaborators/invite` | 邀请 |
| DELETE | `/babies/{id}/collaborators/{openid}` | 移除 |
| PUT | `/babies/{id}/collaborators/{openid}/role` | 更新角色 |
| GET | `/invitations/code/{code}` | 查询邀请 |
| POST | `/babies/join` | 确认加入 |

---

## ⏱️ 权限过期时间线

```
创建日期        正常使用      警告期       过期
    |————————────|———————|———|
    0天          23天   26天 30天(临时权限)
    ✅正常       ✅正常  ⚠️警告 ❌禁用
```

---

## 🔐 安全检查清单

- [ ] 前端权限检查
- [ ] 后端权限验证
- [ ] 过期权限自动禁用
- [ ] 敏感操作前验证权限
- [ ] 权限变更记录日志

---

## 📊 权限数据结构速览

```typescript
// 协作者信息
BabyCollaborator {
  openid: string;           // 用户ID
  nickName: string;         // 用户名
  role: 'admin'|'editor'|'viewer'; // 角色
  accessType: 'permanent'|'temporary'; // 类型
  expiresAt?: number;       // 过期时间(秒)
  isCreator: boolean;       // 是否创建者
}

// 用户权限
MyPermission {
  babyId: string;           // 宝宝ID
  role: 'admin'|'editor'|'viewer'; // 角色
  accessType: 'permanent'|'temporary'; // 类型
  expiresAt?: number;       // 过期时间(秒)
}
```

---

## 🎯 常见场景解决方案

### 场景1：限制普通用户添加记录
```typescript
const permission = getMyPermission(babyId);
if (!canEditRecords(permission)) {
  showToast('您无权修改此宝宝的记录');
  return;
}
```

### 场景2：权限过期自动隐藏宝宝
```typescript
babyList.value = babyList.value.filter(baby => {
  const permission = getMyPermission(baby.babyId);
  return !isPermissionExpired(permission);
});
```

### 场景3：显示权限过期警告
```typescript
const warning = getExpirationWarning(permission);
if (warning) {
  uni.showToast({ title: warning });
}
```

### 场景4：仅 admin 能邀请
```typescript
if (myRole === 'admin') {
  // 显示邀请按钮
} else {
  // 隐藏邀请按钮
}
```

---

## 🚀 快速集成（8步）

1. ✅ 复制 5 个 `.ts` 和 `.vue` 文件
2. ✅ 在 `pages.json` 注册新页面
3. ✅ 在 `list.vue` 导入 `BabyCollaboratorsPreview` 组件
4. ✅ 加载协作者数据：`apiFetchCollaborators(babyId)`
5. ✅ 在需要权限的页面添加检查
6. ✅ 在权限拒绝时显示提示
7. ✅ 测试各种权限场景
8. ✅ 上线！

---

## 💡 设计原则

| 原则 | 说明 |
|------|------|
| 最小权限 | 默认最低权限，明确授权才能升级 |
| 权限隔离 | 不同用户的权限完全独立 |
| 时间限制 | 临时权限必须设置过期时间 |
| 即时生效 | 权限变更立即生效，无延迟 |
| 用户友好 | 清晰的权限提示和过期警告 |

---

## 🎓 推荐阅读顺序

1. **README_协作者管理.md** (本文档)
   - 5分钟了解全貌

2. **多宝宝协作者管理完整解决方案.md**
   - 10分钟理解核心设计

3. **协作者管理系统架构图.md**
   - 15分钟掌握架构细节

4. **多宝宝协作者管理实现清单.md**
   - 20分钟学习实现步骤

5. **代码文件** (collaborator.ts 等)
   - 30分钟理解代码细节

---

## ✨ 核心优势

✅ **开箱即用** - 完整的代码和文档
✅ **类型安全** - 完全的 TypeScript 类型定义
✅ **权限完整** - 11种具体权限定义
✅ **易于扩展** - 清晰的模块化设计
✅ **文档齐全** - 设计、架构、代码都有详细说明

---

## 🔗 相关资源

| 资源 | 位置 |
|------|------|
| 完整设计 | 协作者管理设计方案.md |
| 实现步骤 | 多宝宝协作者管理实现清单.md |
| 架构说明 | 协作者管理系统架构图.md |
| 代码示例 | 各 `.ts` 和 `.vue` 文件 |
| 本文档 | README_协作者管理.md |

---

**🎉 准备好开始了吗？立即查看完整设计文档吧！**

