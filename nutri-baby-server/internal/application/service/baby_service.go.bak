package service

import (
	"context"
	"time"

	"github.com/google/uuid"

	"github.com/wxlbd/nutri-baby-server/internal/application/dto"
	"github.com/wxlbd/nutri-baby-server/internal/domain/entity"
	"github.com/wxlbd/nutri-baby-server/internal/domain/repository"
	"github.com/wxlbd/nutri-baby-server/pkg/errors"
)

// BabyService 宝宝服务
type BabyService struct {
	babyRepo         repository.BabyRepository
	familyMemberRepo repository.FamilyMemberRepository
	vaccineService   *VaccineService
}

// NewBabyService 创建宝宝服务
func NewBabyService(
	babyRepo repository.BabyRepository,
	familyMemberRepo repository.FamilyMemberRepository,
	vaccineService *VaccineService,
) *BabyService {
	return &BabyService{
		babyRepo:         babyRepo,
		familyMemberRepo: familyMemberRepo,
		vaccineService:   vaccineService,
	}
}

// CreateBaby 创建宝宝
func (s *BabyService) CreateBaby(ctx context.Context, openID string, req *dto.CreateBabyRequest) (*dto.BabyDTO, error) {
	// 验证用户是否为家庭成员
	if err := s.checkFamilyMembership(ctx, req.FamilyID, openID); err != nil {
		return nil, err
	}

	// 验证日期格式
	if _, err := time.Parse("2006-01-02", req.BirthDate); err != nil {
		return nil, errors.New(errors.ParamError, "出生日期格式错误，应为YYYY-MM-DD")
	}

	babyID := uuid.New().String()
	now := time.Now().UnixMilli()

	baby := &entity.Baby{
		BabyID:     babyID,
		Name:       req.BabyName,
		Gender:     req.Gender,
		BirthDate:  req.BirthDate,
		AvatarURL:  req.AvatarURL,
		CreateTime: now,
		UpdateTime: now,
	}

	if err := s.babyRepo.Create(ctx, baby); err != nil {
		return nil, err
	}

	// 初始化疫苗提醒
	if err := s.vaccineService.InitializeVaccineReminders(ctx, babyID); err != nil {
		// 记录错误但不影响创建宝宝
		// logger.Error("Failed to initialize vaccine reminders", zap.Error(err))
	}

	return &dto.BabyDTO{
		BabyID:     baby.BabyID,
		FamilyID:   baby.FamilyID,
		BabyName:   baby.Name,
		Gender:     baby.Gender,
		BirthDate:  baby.BirthDate,
		AvatarURL:  baby.AvatarURL,
		CreateTime: baby.CreateTime,
		UpdateTime: baby.UpdateTime,
	}, nil
}

// GetBabyList 获取家庭的宝宝列表
func (s *BabyService) GetBabyList(ctx context.Context, familyID, openID string) ([]dto.BabyDTO, error) {
	// 验证用户是否为家庭成员
	if err := s.checkFamilyMembership(ctx, familyID, openID); err != nil {
		return nil, err
	}

	babies, err := s.babyRepo.FindByFamilyID(ctx, familyID)
	if err != nil {
		return nil, err
	}

	result := make([]dto.BabyDTO, 0, len(babies))
	for _, baby := range babies {
		result = append(result, dto.BabyDTO{
			BabyID:     baby.BabyID,
			FamilyID:   baby.FamilyID,
			BabyName:   baby.Name,
			Gender:     baby.Gender,
			BirthDate:  baby.BirthDate,
			AvatarURL:  baby.AvatarURL,
			CreateTime: baby.CreateTime,
			UpdateTime: baby.UpdateTime,
		})
	}

	return result, nil
}

// GetBabyDetail 获取宝宝详情
func (s *BabyService) GetBabyDetail(ctx context.Context, babyID, openID string) (*dto.BabyDTO, error) {
	baby, err := s.babyRepo.FindByID(ctx, babyID)
	if err != nil {
		return nil, err
	}

	// 验证用户是否为家庭成员
	if err := s.checkFamilyMembership(ctx, baby.FamilyID, openID); err != nil {
		return nil, err
	}

	return &dto.BabyDTO{
		BabyID:     baby.BabyID,
		FamilyID:   baby.FamilyID,
		BabyName:   baby.Name,
		Gender:     baby.Gender,
		BirthDate:  baby.BirthDate,
		AvatarURL:  baby.AvatarURL,
		CreateTime: baby.CreateTime,
		UpdateTime: baby.UpdateTime,
	}, nil
}

// UpdateBaby 更新宝宝信息
func (s *BabyService) UpdateBaby(ctx context.Context, babyID, openID string, req *dto.UpdateBabyRequest) error {
	baby, err := s.babyRepo.FindByID(ctx, babyID)
	if err != nil {
		return err
	}

	// 验证用户是否为家庭成员
	if err := s.checkFamilyMembership(ctx, baby.FamilyID, openID); err != nil {
		return err
	}

	// 更新字段
	if req.BabyName != "" {
		baby.Name = req.BabyName
	}
	if req.Gender != "" {
		baby.Gender = req.Gender
	}
	if req.BirthDate != "" {
		if _, err := time.Parse("2006-01-02", req.BirthDate); err != nil {
			return errors.New(errors.ParamError, "出生日期格式错误，应为YYYY-MM-DD")
		}
		baby.BirthDate = req.BirthDate
	}
	if req.AvatarURL != "" {
		baby.AvatarURL = req.AvatarURL
	}

	baby.UpdateTime = time.Now().UnixMilli()

	return s.babyRepo.Update(ctx, baby)
}

// DeleteBaby 删除宝宝
func (s *BabyService) DeleteBaby(ctx context.Context, babyID, openID string) error {
	baby, err := s.babyRepo.FindByID(ctx, babyID)
	if err != nil {
		return err
	}

	// 验证用户是否为家庭成员
	if err := s.checkFamilyMembership(ctx, baby.FamilyID, openID); err != nil {
		return err
	}

	return s.babyRepo.Delete(ctx, babyID)
}

// checkFamilyMembership 检查用户是否为家庭成员
func (s *BabyService) checkFamilyMembership(ctx context.Context, familyID, openID string) error {
	members, err := s.familyMemberRepo.FindByFamilyID(ctx, familyID)
	if err != nil {
		return err
	}

	for _, member := range members {
		if member.OpenID == openID {
			return nil
		}
	}

	return errors.New(errors.PermissionDenied, "您不是该家庭的成员")
}
